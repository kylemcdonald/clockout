<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Entry History - Clock-Out</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            font-family: Arial, sans-serif;
        }
        body,
        html {
            margin: 0;
            padding: 0;
            height: auto;
            min-height: 100%;
            display: block;
            overflow: visible;
            overflow-y: auto;
            background-color: black;
            color: white;
        }
        .history-container {
            max-width: 1000px;
            margin: 80px auto 20px;
            padding: 20px;
            color: white;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .history-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: normal;
        }
        .back-button {
            padding: 8px 16px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9em;
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .time-entry {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .time-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .project-name {
            font-weight: normal;
            font-size: 1em;
        }
        .project-name-colored {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
        }
        .duration {
            font-size: 1em;
            margin-right: 12px;
        }
        .time-range {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }
        .error {
            background-color: rgba(255, 0, 0, 0.15);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .edit-button,
        .delete-button {
            padding: 6px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 6px;
        }
        .edit-button:hover,
        .delete-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .save-button {
            padding: 6px 12px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 6px;
        }
        .save-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .cancel-button {
            padding: 6px 12px;
            background-color: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 6px;
        }
        .cancel-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .edit-mode .time-range {
            display: none;
        }
        .edit-mode .edit-form {
            display: block;
            margin-top: 12px;
        }
        .edit-form {
            display: none;
        }
        .edit-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            padding: 6px 10px;
            color: white;
            font-size: 1em;
            margin-right: 8px;
            width: 200px;
        }
        .edit-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.12);
        }
        .edit-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .date-header {
            font-size: 1.2em;
            font-weight: normal;
            margin-top: 32px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .date-header:first-child {
            margin-top: 0;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 30px;
            padding: 20px 0;
        }
        .pagination-button {
            padding: 8px 16px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .pagination-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        .page-nav {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            display: flex;
            gap: 10px;
        }
        .page-nav a {
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .page-nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="page-nav">
        <a href="/" title="Track">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                <path fill-rule="evenodd" d="M3 6a3 3 0 0 1 3-3h2.25a3 3 0 0 1 3 3v2.25a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6Zm9.75 0a3 3 0 0 1 3-3H18a3 3 0 0 1 3 3v2.25a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3V6ZM3 15.75a3 3 0 0 1 3-3h2.25a3 3 0 0 1 3 3V18a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-2.25Zm9.75 0a3 3 0 0 1 3-3H18a3 3 0 0 1 3 3V18a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3v-2.25Z" clip-rule="evenodd"/>
            </svg>
        </a>
        <a href="/history" title="History">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z" clip-rule="evenodd"/>
            </svg>
        </a>
        <a href="/settings" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                <path fill-rule="evenodd" d="M12 6.75a5.25 5.25 0 0 1 6.775-5.025.75.75 0 0 1 .313 1.248l-3.32 3.319c.063.475.276.934.641 1.299.365.365.824.578 1.3.64l3.318-3.319a.75.75 0 0 1 1.248.313 5.25 5.25 0 0 1-5.472 6.756c-1.018-.086-1.87.1-2.309.634L7.344 21.3A3.298 3.298 0 1 1 2.7 16.657l8.684-7.151c.533-.44.72-1.291.634-2.309A5.342 5.342 0 0 1 12 6.75ZM4.117 19.125a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75h-.008a.75.75 0 0 1-.75-.75v-.008Z" clip-rule="evenodd"/>
            </svg>
        </a>
    </div>
    <div class="history-container">
        <div class="history-header">
            <h1>Time Entry History</h1>
        </div>
        <div id="errorMessage" style="display: none;"></div>
        <div id="loadingMessage" class="loading">Loading time entries...</div>
        <div id="timeEntriesList"></div>
        <div id="pagination" style="display: none;"></div>
    </div>

    <script>
        let projectColors = {}; // Map project name to color
        let allEntries = []; // Store all entries for pagination
        let currentPage = 1;
        const entriesPerPage = 20;

        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        function getApiHeaders() {
            const apiKey = getCookie('apiToken');
            return {
                'Authorization': `Bearer ${apiKey}`,
                'X-API-Key': apiKey
            };
        }

        async function fetchProjects() {
            const apiKey = getCookie('apiToken');
            if (!apiKey) {
                return;
            }

            try {
                const response = await fetch('/api/projects', {
                    headers: getApiHeaders()
                });

                if (response.status === 401) {
                    return;
                }

                if (!response.ok) {
                    return;
                }

                const projects = await response.json();
                projectColors = {};
                projects.forEach(project => {
                    projectColors[project.name] = project.color || '#D15540';
                });
            } catch (error) {
                console.error('Error fetching projects:', error);
            }
        }

        function formatDuration(seconds) {
            if (seconds < 0) return 'Running...';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            }
            return `${minutes}m ${secs}s`;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatDateTimeForInput(dateString) {
            const date = new Date(dateString);
            // Format for datetime-local input: YYYY-MM-DDTHH:MM in LOCAL timezone
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        async function deleteTimeEntry(entryId) {
            if (!confirm('Are you sure you want to delete this time entry? This action cannot be undone.')) {
                return;
            }

            const apiKey = getCookie('apiToken');
            if (!apiKey) {
                alert('No API key found. Please go to settings and enter your API key.');
                return;
            }

            try {
                const response = await fetch(`/api/time-entries/${entryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'X-API-Key': apiKey
                    }
                });

                if (response.status === 401) {
                    throw new Error('Invalid API key');
                }

                if (!response.ok) {
                    throw new Error(`Failed to delete time entry: ${response.status}`);
                }

                // Remove the entry from allEntries array
                allEntries = allEntries.filter(entry => entry.id !== entryId);

                // Re-render entries with updated data
                renderEntries();

            } catch (error) {
                console.error('Error deleting time entry:', error);
                alert(`Error deleting time entry: ${error.message}`);
            }
        }

        function editTimeEntry(entryId) {
            const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryElement) {
                entryElement.classList.add('edit-mode');
            }
        }

        function cancelEdit(entryId) {
            const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryElement) {
                entryElement.classList.remove('edit-mode');
            }
        }

        async function saveTimeEntry(entryId) {
            const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (!entryElement) return;

            const startInput = entryElement.querySelector('.start-input');
            const endInput = entryElement.querySelector('.end-input');

            const startTime = startInput.value;
            const endTime = endInput.value;

            if (!startTime) {
                alert('Start time is required');
                return;
            }

            const apiKey = getCookie('apiToken');
            if (!apiKey) {
                alert('No API key found. Please go to settings and enter your API key.');
                return;
            }

            try {
                const response = await fetch(`/api/time-entries/${entryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        start_time: new Date(startTime).toISOString(),
                        end_time: endTime ? new Date(endTime).toISOString() : null
                    })
                });

                if (response.status === 401) {
                    throw new Error('Invalid API key');
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to update time entry: ${response.status}`);
                }

                // Reload the page to refresh all data
                loadTimeEntries();

            } catch (error) {
                console.error('Error updating time entry:', error);
                alert(`Error updating time entry: ${error.message}`);
            }
        }

        async function loadTimeEntries() {
            const apiKey = getCookie('apiToken');
            if (!apiKey) {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'No API key found. Please go to settings and enter your API key.';
                document.getElementById('errorMessage').className = 'error';
                return;
            }

            try {
                const response = await fetch('/api/time-entries', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'X-API-Key': apiKey
                    }
                });

                if (response.status === 401) {
                    throw new Error('Invalid API key');
                }

                if (!response.ok) {
                    throw new Error(`Failed to load time entries: ${response.status}`);
                }

                const entries = await response.json();
                document.getElementById('loadingMessage').style.display = 'none';
                
                if (entries.length === 0) {
                    document.getElementById('timeEntriesList').innerHTML = '<div class="loading">No time entries found for the last week.</div>';
                    document.getElementById('pagination').style.display = 'none';
                    return;
                }

                // Store all entries for pagination
                allEntries = entries;
                currentPage = 1; // Reset to first page when reloading

                renderEntries();
            } catch (error) {
                console.error('Error loading time entries:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').className = 'error';
            }
        }

        function renderEntries() {
            if (allEntries.length === 0) {
                document.getElementById('timeEntriesList').innerHTML = '<div class="loading">No time entries found for the last week.</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            const paginatedEntries = allEntries.slice(startIndex, endIndex);

            // Group entries by date
            const entriesByDate = {};
            paginatedEntries.forEach(entry => {
                const dateKey = formatDate(entry.start);
                if (!entriesByDate[dateKey]) {
                    entriesByDate[dateKey] = [];
                }
                entriesByDate[dateKey].push(entry);
            });

            // Sort dates in descending order (most recent first)
            const sortedDates = Object.keys(entriesByDate).sort((a, b) => {
                return new Date(b) - new Date(a);
            });

            // Build HTML with date headers
            let entriesHtml = '';
            sortedDates.forEach(dateKey => {
                // Add date header
                entriesHtml += `<div class="date-header">${dateKey}</div>`;
                
                // Add entries for this date
                entriesByDate[dateKey].forEach(entry => {
                    const startTime = formatTime(entry.start);
                    const endTime = entry.stop ? formatTime(entry.stop) : 'Running...';
                    const duration = formatDuration(entry.duration);
                    const projectName = entry.name || 'Unknown Project';
                    const projectColor = projectColors[projectName] || '#D15540';
                    const projectNameStyle = `background-color: ${projectColor};`;

                    entriesHtml += `
                        <div class="time-entry" data-entry-id="${entry.id}">
                            <div class="time-entry-header">
                                <span class="project-name project-name-colored" style="${projectNameStyle}">${projectName}</span>
                                <div>
                                    <span class="duration">${duration}</span>
                                    <button class="edit-button" onclick="editTimeEntry(${entry.id})">Edit</button>
                                    <button class="delete-button" onclick="deleteTimeEntry(${entry.id})">Delete</button>
                                </div>
                            </div>
                            <div class="time-range">
                                ${startTime} â†’ ${endTime}
                            </div>
                            <div class="edit-form">
                                <input type="datetime-local" class="edit-input start-input" value="${formatDateTimeForInput(entry.start)}" placeholder="Start time">
                                <input type="datetime-local" class="edit-input end-input" value="${entry.stop ? formatDateTimeForInput(entry.stop) : ''}" placeholder="End time (leave empty if running)">
                                <button class="save-button" onclick="saveTimeEntry(${entry.id})">Save</button>
                                <button class="cancel-button" onclick="cancelEdit(${entry.id})">Cancel</button>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('timeEntriesList').innerHTML = entriesHtml;

            // Render pagination controls if there are more than 20 entries
            if (allEntries.length > entriesPerPage) {
                const totalPages = Math.ceil(allEntries.length / entriesPerPage);
                const paginationHtml = `
                    <div class="pagination">
                        <button class="pagination-button" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                        <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                        <button class="pagination-button" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = paginationHtml;
                document.getElementById('pagination').style.display = 'flex';
            } else {
                document.getElementById('pagination').style.display = 'none';
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderEntries();
                // Scroll to top of entries list
                document.getElementById('timeEntriesList').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Load projects first to get colors, then load time entries
        fetchProjects().then(() => {
            loadTimeEntries();
        });
    </script>
</body>
</html>

